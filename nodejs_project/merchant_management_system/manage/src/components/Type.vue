<template>
  <div class="type">
    <div class="clearfix search-inner-layout">
      <div class="fl type-title">商品类型</div>
      <div class="search fl">
        <input
          type="text"
          class="form-control"
          placeholder="输入类型名称"
          v-model="typeTitle"
          @keyup.enter="search"
        />
      </div>
      <div class="fl">
        <button class="btn btn-primary" @click="search">搜索</button>
      </div>
    </div>
    <!-- 搜索 -->

    <div class="add">
      <button class="btn btn-warning" @click="showModal(1)">
        添加商品类型
      </button>
      <button
        class="btn btn-warning"
        @click="update({ key: 'showListStatu', value: !showListStatu })"
      >
        {{ showListBtnText }}
      </button>
      <select multiple v-model="showList" v-show="showListStatu">
        <option value="-1" disabled selected>全部</option>
        <option v-for="(item, index) in headList" :key="index" :value="item">
          {{ item }}
        </option>
      </select>
    </div>
    <!-- 添加商品类型按钮 -->

    <div class="type-list">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th
              v-for="(item, index) in headList"
              :key="index"
              v-show="showList.includes(item)"
            >
              {{ item }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(item, index) in typeData" :key="index">
            <td v-show="showList.includes(headList[0])">{{ index + 1 }}</td>
            <td v-show="showList.includes(headList[1])">{{ item.type }}</td>
            <td v-show="showList.includes(headList[2])">
              {{ item.isEnable ? "正常" : "禁用" }}
            </td>
            <td v-show="showList.includes(headList[3])">
              {{ item.createdAt }}
            </td>
            <td v-show="showList.includes(headList[4])">
              {{ item.updatedAt }}
            </td>
            <td v-show="showList.includes(headList[5])">
              <button
                class="btn btn-info btn-sm edit"
                @click="showModal(2, index)"
              >
                编辑
              </button>
              <button
                class="btn btn-danger btn-sm"
                v-if="item.isEnable"
                @click="toggleTypeStatus(0, item.typeId, index)"
              >
                禁用
              </button>
              <button
                class="btn btn-secondary btn-sm"
                v-else
                @click="toggleTypeStatus(1, item.typeId, index)"
              >
                启用
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- 商品类型列表 -->

    <nav v-if="typeData.length > 0">
      <ul class="pagination justify-content-center">
        <li
          class="page-item"
          :class="{ disabled: currentPage == 1 }"
          @click="togglePage()"
        >
          <a class="page-link" href="javascript:void(0);">上一页</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="javascript:void(0);">{{ currentPage }}</a>
        </li>
        <li
          class="page-item"
          :class="{ disabled: currentPage == totalPage }"
          @click="togglePage(true)"
        >
          <a class="page-link" href="javascript:void(0);">下一页</a>
        </li>
        <li>
          <a class="page-link" href="javascript:void(0);"
            >共 {{ totalPage }} 页</a
          >
        </li>
      </ul>
    </nav>
    <!-- 分页 -->

    <div class="modal fade" id="modal" ref="modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{ title }}</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group clearfix">
                <div class="fl type-name">类型名称</div>
                <div class="fl type-ipt">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="输入类型名称"
                    v-model="type"
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" @click="saveType">
              保存
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- 模态框 -->
  </div>
  <!-- 类型组件 -->
</template>

<script>
//导入jquery
import $ from "jquery";

//导入公共方法文件
import { tool } from "../assets/js/tool.js";
import { mapMutations, mapState, mapGetters } from "vuex";

export default {
  name: "Type",
  computed: {
    ...mapState(["headList"]),
    ...mapState("dynamicData", [
      "typeData",
      // typeData: 商品类型数据
      "title",
      // title: 添加或者编辑商品类型标题
      "typeId",
      // typeId 编辑商品类型的id
      "index",
      // index 记录编辑的商品类型下标
      "isSearch",
      // isSearch 搜索标记
      "currentPage",
      // currentPage 当前页码
      "pageCount",
      // pageCount 每页显示10条数据
      "totalPage",
      // totalPage 总页数
      "showListStatu",
      // 展示列表状态
    ]),
    ...mapGetters("dynamicData", [
      "showListBtnText",
      // 展示列表按钮文字
    ]),
    type: {
      get() {
        return this.$store.state.dynamicData.type;
      },
      set(v) {
        this.$store.state.dynamicData.type = v;
      },
    },
    // type: 商品类型名称
    typeTitle: {
      get() {
        return this.$store.state.dynamicData.typeTitle;
      },
      set(v) {
        this.$store.state.dynamicData.typeTitle = v;
      },
    },
    // typeTitle: 搜索类型
    showList: {
      get() {
        return this.$store.state.dynamicData.showList;
      },
      set(v) {
        console.log(v);
        this.$store.state.dynamicData.showList = v;
      },
    },
  },

  //一般用于初始化页面数据
  created() {
    this.getTypeData();
    //获取商品类型数据

    this.getTypeDataRows();
    //获取数据表的数据数量
  },

  methods: {
    ...mapMutations("dynamicData", ["update", "showTips"]),
    // update 更新vuex数据
    // showTips 展示提示
    saveType() {
      if (
        (typeof this.type === "string" && this.type.trim() == "") ||
        this.type == null
      ) {
        this.showTips("输入类型名称");
        return;
      }
      // 输入框判断

      if (!this.typeId) {
        this.axios({
          method: "POST",
          url: "/addType",
          data: {
            type: this.type,
          },
        })
          .then((result) => {
            console.log("添加类型", result);

            if (result.data.code == 1040) {
              this.update({ key: "currentPage", value: 1 });

              //兼容 获取商品类型数据

              this.getTypeData();
              //获取商品类型

              this.getTypeDataRows();
              //获取数据表的数据数量

              $(this.$refs.modal).modal("hide");

              this.showTips(result.data.msg);

              this.update({ key: "type", value: "" });
            }
          })
          .catch((err) => {
            console.log(err);
          });
        //发起添加类型数据请求
      } else {
        if (this.type == this.typeData[this.index].type) {
          $(this.$refs.modal).modal("hide");
          this.update({ key: "type", value: "" });
          // 重置
          return;
        }
        //验证商品类型是否更改

        this.axios({
          method: "POST",
          url: "/type",
          data: {
            typeId: this.typeId,
            type: this.type,
          },
        })
          .then((result) => {
            if (result.data.code == 1048) {
              $(this.$refs.modal).modal("hide");
              this.showTips(result.data.msg);
              this.$store.state.dynamicData.typeData[
                this.index
              ].type = this.type;
              this.$store.state.dynamicData.typeData[
                this.index
              ].updateAt = too.formatDate(new Date(), "yyyy-MM-dd hh:mm:ss");
              this.update({ key: "type", value: "" });
            }
          })
          .catch((err) => {});
        //编辑商品类型
      }
      // 兼容添加商品和编辑商品
    },
    //保存商品类型

    getTypeData() {
      this.axios({
        method: "GET",
        url: "/getType",
        params: {
          offset: (this.currentPage - 1) * this.pageCount,
          //偏移数据量

          limit: this.pageCount,
          //查询数据量
        },
      })
        .then((result) => {
          result.data.result.forEach((v) => {
            v.createdAt = tool.formatDate(
              new Date(v.createdAt),
              "yyyy-MM-dd hh:mm:ss"
            );

            v.updatedAt = tool.formatDate(
              new Date(v.updatedAt),
              "yyyy-MM-dd hh:mm:ss"
            );
          });

          this.update({ key: "typeData", value: result.data.result });
          // 更新类型数据
          // this.update({key: "typeData", value: result.data.result})

          this.update({
            key: "isSearch",
            value: false,
          });
          this.update({ key: "isSearch", value: false });

          this.update({ key: "typeTitle", value: "" });
        })
        .catch((err) => {});
    },
    //获取商品类型数据

    search() {
      if (
        (typeof this.typeTitle === "string" && this.typeTitle.trim() == "") ||
        this.typeTitle == null
      ) {
        this.showTips("请输入类型名称");
        return;
      }

      this.update({ key: "currentPage", value: 1 });

      this.searchType();
      //搜索商品类型

      this.seacrchRows();
      //获取搜索商品数量
    },
    // 搜索

    searchType() {
      this.axios({
        method: "GET",
        url: "/searchType",
        params: {
          type: this.typeTitle,
          offset: (this.currentPage - 1) * this.pageCount,
          limit: this.pageCount,
        },
      })
        .then((result) => {
          console.log("结果", result);
          result.data.result.forEach((v) => {
            v.createdAt = tool.formatDate(
              new Date(v.createdAt),
              "yyyy-MM-dd hh:mm:ss"
            );

            v.updatedAt = tool.formatDate(
              new Date(v.updatedAt),
              "yyyy-MM-dd hh:mm:ss"
            );
          });
          this.update({ key: "typeData", value: result.data.result });

          this.update({ key: "isSearch", value: true });
        })
        .catch((err) => {});
    },
    //搜索商品类型

    seacrchRows() {
      this.axios({
        method: "GET",
        url: "/searchRows",
        params: {
          type: this.typeTitle,
        },
      })
        .then((result) => {
          console.log("数量", result);
          //分页
          this.update({
            key: "totalPage",
            value: Math.ceil(result.data.result / this.pageCount),
          });
        })
        .catch((err) => {});
    },
    //搜索商品类型数据数量，用于搜索分页

    toggleTypeStatus(status, typeId, index) {
      this.axios({
        method: "POST",
        url: "/typeStatus",
        data: {
          status,
          typeId,
        },
      })
        .then((result) => {
          if (result.data.code == 1046) {
            // console.log("更新", result);
            // this.typeData[index].isEnable = status;
            this.$store.state.dynamicData.typeData[index].isEnable = status;
            this.showTips(result.data.msg);
          }
        })
        .catch((err) => {
          console.log(err);
        });
    },
    //禁用和启用

    showModal(flag, index) {
      if (flag == 2) {
        this.update({ key: "typeId", value: this.typeData[index].typeId });
        this.update({ key: "type", value: this.typeData[index].type });
        this.update({ key: "title", value: "编辑商品类型" });
        this.update({ key: "index", value: index });
        // 标记
      } else {
        this.update({ key: "typeId", value: "" });
        // 兼容编辑商品类型操作
        this.update({ key: "type", value: "" });
        // 初始化
        this.update({ key: "title", value: "添加商品类型" });
      }

      $(this.$refs.modal).modal("show");
    },
    //显示模态框

    getTypeDataRows() {
      this.axios({
        method: "GET",
        url: "/typeRows",
      })
        .then((result) => {
          //分页
          this.update({
            key: "totalPage",
            value: Math.ceil(result.data.result / this.pageCount),
          });
        })
        .catch((err) => {});
    },
    //获取数据表的数据数量, 用于分页

    togglePage(isNext) {
      //下一页
      if (isNext) {
        if (this.currentPage < this.totalPage) {
          this.update({ key: "currentPage", value: this.currentPage + 1 });

          if (this.isSearch) {
            this.searchType();
          } else {
            this.getTypeData();
          }
        }
      } else {
        //上一页
        if (this.currentPage > 1) {
          this.update({ key: "currentPage", value: this.currentPage - 1 });

          if (this.isSearch) {
            this.searchType();
          } else {
            this.getTypeData();
          }
        }
      }
    },
    //点击上下页
  },
};
</script>

<style lang="less" scoped>
.page-item {
  user-select: none;
}
.type-ipt {
  width: calc(~"100% - 80px");
}
.type-name {
  width: 80px;
  line-height: 38px;
}
.edit {
  margin: 0 10px;
  @media (max-width: 576px) {
    // margin: 0 0 8px;
  }
}
.type-list {
  margin-top: 20px;
}
.add {
  position: relative;

  margin-top: 20px;
  display: flex;
  justify-content: space-between;

  select {
    position: absolute;
    right: 90px;
    top: 0;
    height: 160px;

    // display: none;
  }
}
.type-title {
  line-height: 38px;
}
.search {
  width: calc(100% - 192px);
  margin: 0 20px;
}
</style>