<template>
  <div class="form-group-inner-layout register">
    <div class="form-group clearfix">
      <label class="fl form-title" :for="email">邮箱</label>
      <!-- 字段头 -->
      <div class="fl form-input">
        <input
          type="text"
          class="form-control"
          id="email"
          autocomplete="off"
          v-model="email"
          placeholder="请输入邮箱"
        />
      </div>
      <!-- 输入字段 -->
    </div>
    <!-- 表单行 -->

    <div class="form-group clearfix">
      <label class="fl form-title" for="nickname">昵称</label>
      <!-- 字段头 -->
      <div class="fl form-input">
        <input
          type="text"
          class="form-control"
          id="nickname"
          autocomplete="off"
          v-model="nickName"
          placeholder="昵称1-10个字符"
        />
      </div>
      <!-- 输入字段 -->
    </div>
    <!-- 表单行 -->

    <div class="form-group clearfix">
      <label class="fl form-title" for="password">密码</label>
      <!-- 字段头 -->
      <div class="fl form-input">
        <input
          type="text"
          class="form-control"
          id="password"
          autocomplete="off"
          v-model="passWord"
          placeholder="密码6-16个字符"
        />
      </div>
      <!-- 输入字段 -->
    </div>
    <!-- 表单行 -->

    <div class="form-group clearfix">
      <label class="fl form-title" for="code">验证码</label>
      <!-- 字段头 -->
      <div class="fl form-input valid-form-input">
        <input
          type="text"
          class="form-control"
          id="code"
          autocomplete="off"
          v-model="code"
          placeholder="请输入六位验证码"
        />
      </div>
      <!-- 输入字段 验证码-->

      <div class="valid-code fl">
        <button
          class="btn btn-secondary btn-block"
          :disabled="codeIsSend"
          @click="getCode"
        >
          {{ codeHandlePrompt }}
        </button>
        <!-- 使用disabled属性节流 -->
      </div>
      <!-- 验证状态 -->
    </div>
    <!-- 表单行 -->

    <div class="form-group form-btn-box">
      <div class="btn-box">
        <button class="btn btn-primary btn-block" @click="register">
          注册
        </button>
      </div>
      <!-- 提交按钮行 -->
      <div class="clearfix login-text">
        <span class="fr" @click="goLogin">已有账号，立即登录</span>
      </div>
      <!-- 登录链接 -->
    </div>
    <!-- 提交按钮盒子 -->
  </div>
  <!-- 注册表单 -->
</template>

<script>
import validForm from "../assets/js/validForm";
//导入表单验证构造函数示例
// 其valid方法
// 参数 类型: 对象 其属性必须是实例属性
//验证通过返回true, 否则返回一对象 含通过状态属性: pass 提示文字: msg

import Register from "../components/Register";
// 导入注册表单

import { mapState, mapGetters, mapMutations } from "vuex";

export default {
  name: "Register",

  computed: {
    ...mapState(["appName"]),
    // 项目名称
    ...mapState("dynamicData", [
      "codeHandlePrompt",
      // 验证码操作提示
      "codeIsSend",
      // 验证码是否发送
    ]),
    ...mapGetters("dynamicData", ["registerInfo"]),
    // 动态
    email: {
      get() {
        return this.$store.state.dynamicData.email;
      },
      set(v) {
        this.$store.state.dynamicData.email = v;
      },
    },
    // vuex双向绑定 邮箱
    nickName: {
      get() {
        return this.$store.state.dynamicData.nickName;
      },
      set(v) {
        this.$store.state.dynamicData.nickName = v;
      },
    },
    // vuex双向绑定 昵称
    passWord: {
      get() {
        return this.$store.state.dynamicData.passWord;
      },
      set(v) {
        this.$store.state.dynamicData.passWord = v;
      },
    },
    // vuex双向绑定 密码
    code: {
      get() {
        return this.$store.state.dynamicData.code;
      },
      set(v) {
        this.$store.state.dynamicData.code = v;
      },
    },
    // vuex双向绑定 验证码
  },
  methods: {
    ...mapMutations("dynamicData", ["update", "showTips"]),
    // update 更新vuex数据
    // showTips 展示提示
    getCode() {
      let data = { email: this.email };
      let res = validForm.valid(data);

      if (res.pass === false) {
        this.showTips(res.msg);

        return;
      }
      //验证邮箱格式是否正确并进行msg组件交互

      let time = 5;

      this.update({
        name: "dynamicData",
        key: "codeHandlePrompt",
        value: `${time}s后重新发送`,
      });
      this.update({ name: "dynamicData", key: "codeIsSend", value: true });
      let timer = setInterval(() => {
        if (time == 0) {
          clearInterval(timer);
          timer = null;
          this.update({
            name: "dynamicData",
            key: "codeHandlePrompt",
            value: `发送邮箱验证码`,
          });
          this.update({ name: "dynamicData", key: "codeIsSend", value: false });
        } else {
          time--;
          this.update({
            name: "dynamicData",
            key: "codeHandlePrompt",
            value: `${time}s后重新发送`,
          });
        }
      }, 1000);
      // 使用isSend动态变化配合disabled属性节流;

      this.axios({
        method: "POST",
        url: "/sendMail",
        data: data,
      })
        .then((result) => {
          this.showTips(result.data.msg);
        })
        .catch((err) => {
          console.log(err);
        });
      //发送邮箱验证码请求
    },
    //获取邮箱验证码

    register() {
      let result = validForm.valid(this.registerInfo);
      if (result.pass === false) {
        this.showTips(result.msg);
      }
      //表单验证

      this.axios({
        method: "post",
        url: "/register",
        data: this.registerInfo,
      })
        .then((res) => {
          if (res.data.code === 1000) {
            this.showTips(res.data.msg);
            this.goLogin();
          }
        })
        .catch((err) => {
          console.log("err ==> ", err);
        });
    },
    //注册

    goLogin() {
      this.$router.push({ name: "Login" });
    },
    //跳转登录
  },
};
</script>


<style lang="less" scoped>
.form-group-inner-layout {
  margin-top: 4vw;
  // 响应式
  background-color: #fff;
  padding: 15px;
  border-radius: 10px;

  .form-title {
    width: 60px;
    height: 30px;
    position: relative;
    left: 0;
    top: 9px;
  }
  // 字段头
  .form-input {
    width: calc(100% - 60px);
    vertical-align: middle;
    display: inline-block;
  }

  .valid-code {
    width: 160px;
    @media (max-width: 410px){
      margin: 8px 0 0 60px;
    }
  }
  // 验证码状态

  .valid-form-input {
    width: 160px;
    margin-right: 20px;
  }
  // 验证码输入字段

  .form-btn-box {
    margin-bottom: 0;
    .btn-box {
      margin-left: 60px;
    }
    .login-text {
      margin-top: 16px;
      color: #444;
      cursor: pointer;
    }
  }
  // 提交
}
// 注册表单

@media (min-width: 992px) {
  .form-group-inner-layout {
    margin-top: 0;
    // 兼容
  }
}
</style>