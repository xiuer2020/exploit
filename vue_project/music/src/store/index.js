import Vue from "vue";
import Vuex from "vuex";
import modules from "./modules/modules";
import types from './modules/types';


Vue.use(Vuex);

export default new Vuex.Store({
  state: {
    err: null,
    prevPath: "",
    lyricPage: false,
    playing: false,
    showLoading: false,
    currentSong: {},
    currentSongList: [],
    currentSongListIndex: -1
  },
  getters: {
    currentSongUrl: state => {
      if (state.currentSong) {
        return `https://music.163.com/song/media/outer/url?id=${state.currentSong.id}.mp3`;
      } else {
        return null
      }
    },
    currentSongPicUrl: state => {
      if (state.currentSong.picUrl) {
        return state.currentSong.picUrl;
      } else if (state.currentSong.al) {
        return state.currentSong.al.picUrl;
      } else if (state.currentSong.artists) {
        return state.currentSong.artists.img1v1Url || state.currentSong.artists[0].img1v1Url;
      } else {
        return "";
      }
    },


    currentSongArtists: state => {
      if (state.currentSong.song) {
        return state.currentSong.song.artists;
      } else if (state.currentSong.ar) {
        return state.currentSong.ar;
      } else if (state.currentSong.artists) {
        return state.currentSong.artists;
      } else {
        return [];
      }
    },
    currentSongDuration: state => {
      if (state.currentSong.song) {
        return state.currentSong.song.duration;
      } else if (state.currentSong.dt) {
        return state.currentSong.dt;
      } else if (state.currentSong.duration) {
        return state.currentSong.duration;
      } else {
        return 0;
      }
    },

    // 编译歌词
    compileLlyrics: state => {
      if (state.currentLyric) {
        return state.currentLyric.split("\n").map(item => {
          //
          var regex = /\d{2}:\d{2}\.\d+/i;
          if (item.search(regex) !== -1) {
            var time = item.match(regex)[0];
            var m = time.substr(0, 2);
            var s = time.substr(3, 2);
            var n = time.substr(5);
            return {
              time: Number(m) * 60 + Number(s) + Number(n),
              text: item.substr(11) || "---------"
            };
          } else {
            return {};
          }
        });
      } else {
        return null;
      }
    }
  },
  mutations: {
    [types.UPDATE](state, payload) {
      if (payload.name) {
        state[payload.name][payload.key] = payload.value;
      } else {

        state[payload.key] = payload.value;
      }
    }
  },
  actions: {

    [types.UPDATE]({
      commit
    }, n) {
      commit(types.UPDATE, {
        n
      });
    }
  },
  modules
});