<template>
  <div
    class="control"
    :style="`backgrou-image:url(${currentSongPicUrl})`"
    @click="$router.push({ path: 'lyric' })"
  >
    <BgFilter></BgFilter>
    <Guide></Guide>
    <div class="needle"></div>
    <div class="black-adhesive" :class="{ active: playing }">
      <img :src="currentSongPicUrl" alt />
    </div>
    <div class="controls">
      <i class="fa fa-fast-backward" @click.stop="switchPrevSong"></i>
      <i
        class="fa fa-pause"
        v-if="playing"
        @click.stop="UPDATE({ key: 'playing', value: !playing })"
      ></i>
      <i
        class="fa fa-play"
        v-else
        @click.stop="UPDATE({ key: 'playing', value: !playing })"
      ></i>
      <i class="fa fa-fast-forward" @click.stop="switchNextSong"></i>
    </div>
  </div>
</template>

<script>
import { mapState, mapGetters, mapMutations } from "vuex";
import BgFilter from "../components/BgFilter";
import Guide from "../components/Guide";
import types from "../store/modules/types";

export default {
  components: {
    BgFilter,
    Guide,
  },
  computed: {
    ...mapState([
      "playing",
      "err",
      "currentSongList",
      "currentSongListIndex",
      "lyricPage",
    ]),
    ...mapGetters(["currentSongPicUrl", "currentSongDuration"]),
  },
  beforeRouteEnter(to, from, next) {
    console.log(from);
    if (from.name !== "lyric") {
      next((vm) => {
        vm.UPDATE({ key: "prevPath", value: from.fullPath });
        vm.UPDATE({ key: "lyricPage", value: false });
      });
    } else {
      next((vm) => {
        vm.UPDATE({ key: "lyricPage", value: false });
      });
    }
    // 更新点击播放栏是否显示歌词页 和 点击播放栏的路径
  },
  mounted() {
    var audio = this.$root.$el.querySelector("audio");
    // 获取 canvas , audio节点
    audio.ontimeupdate = () => {
      if ((audio.currentTime + 2) * 1000 >= this.currentSongDuration) {
        if (this.currentSongListIndex !== this.currentSongList.length - 1) {
          this.UPDATE({
            key: "currentSongListIndex",
            value: this.currentSongListIndex + 1,
          });
          // 更新currentSongListIndex
        } else {
          this.UPDATE({
            key: "currentSongListIndex",
            value: 0,
          });
          // 更新currentSongListIndex
        }
        this.UPDATE({
          key: "currentSong",
          value: this.currentSongList[this.currentSongListIndex],
        });
        // 更新currentSong

        if (this.currentSongList.length === 1) {
          this.UPDATE({
            key: "playing",
            value: false,
          });
          // 更新playing
        }
      }
      // 当歌曲播放完毕
    };
  },
  methods: {
    ...mapMutations([types.UPDATE]),
    switchPrevSong: function () {
      if (this.currentSongListIndex > 0) {
        // 是否队列中第一首歌

        this.UPDATE({
          key: "currentSongListIndex",
          value: this.currentSongListIndex - 1,
        });
        // 更新当前歌曲所在下标

        this.UPDATE({
          key: "currentSong",
          value: this.currentSongList[this.currentSongListIndex],
        });
        // 更新当前歌曲
      } else {
        // 是否队列中第一首歌

        this.UPDATE({
          key: "currentSongListIndex",
          value: this.currentSongList.length - 1,
        });
        // 更新当前歌曲所在下标

        this.UPDATE({
          key: "currentSong",
          value: this.currentSongList[this.currentSongListIndex],
        });
        // 更新当前歌曲
      }
    },
    // 上一首

    switchNextSong: function () {
      if (this.currentSongListIndex < this.currentSongList.length - 1) {
        // 是否队列中最后一首歌

        this.UPDATE({
          key: "currentSongListIndex",
          value: this.currentSongListIndex + 1,
        });
        // 更新当前歌曲所在下标

        this.UPDATE({
          key: "currentSong",
          value: this.currentSongList[this.currentSongListIndex],
        });
        // 更新当前歌曲
      } else {
        // 是否队列中最后一首歌

        this.UPDATE({ key: "currentSongListIndex", value: 0 });
        // 更新当前歌曲所在下标

        this.UPDATE({
          key: "currentSong",
          value: this.currentSongList[this.currentSongListIndex],
        });
        // 更新当前歌曲
      }
    },
    // 下一首
  },
};
</script>

<style lang="less" scoped>
@keyframes play {
  to {
    transform: rotate(0);
  }
  from {
    transform: rotate(-360deg);
  }
}
.control {
  position: relative;
  z-index: 0;

  min-height: 100vh;
  background: #00000080;
  overflow: hidden;

  .needle {
    position: absolute;
    left: 50%;
    top: 0;
    z-index: 2;

    width: 18vw;
    height: 26vw;
    transform-origin: 0 0;
    transform: translateX(-50%);

    background: url("../assets/images/needle.png") left top / 100% auto
      no-repeat;
  }
  .black-adhesive {
    margin: 14vw auto 0;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 2.87rem;
    height: 2.87rem;

    background: url("../assets/images/disc_light-ip6.png"),
      url("../assets/images/disc-ip6.png");
    background-size: 100% auto;
    animation: play 8s linear 0s infinite paused;
    &.active {
      animation: play 8s linear 0s infinite running;
    }
    img {
      width: 1.85rem;
      border-radius: 50%;
    }
  }
  .controls {
    display: flex;
    margin-top: 0.3rem;
    margin-bottom: 0.14rem;
    justify-content: space-around;
    i {
      color: #f7dbdb;
      text-align: center;

      display: block;
      border-radius: 50%;
      &::before {
        font-size: 0.76rem;
      }
    }
  }
}
</style>