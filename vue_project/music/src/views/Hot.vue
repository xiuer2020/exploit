<template>
  <div class="playlist">
    <HomeLink></HomeLink>
    <div class="poster">
      <div class="poster-content"></div>
    </div>
    <SongItem
      v-for="(item,index) in songListDetail.tracks"
      :key="index"
      @tanslate-song="$emit('tanslate-song',$event)"
      :songItem="item"
      :currentSong="currentSong"
      :playing="playing"
      :number="index"
      :showNumber="true"
    ></SongItem>
  </div>
</template>

<script>
import HomeLink from "../components/HomeLink.vue";
import SongItem from "../components/SongItem.vue";
import { mapState, mapMutations, mapActions } from "vuex";

export default {
  name: "Hot",
  components: {
    HomeLink,
    SongItem
  },
  props: {
    playing: Boolean,
    currentSong: Object
  },
  data: function() {
    return {
      songListDetail: null
    };
  },
  computed: {
    ...mapState(["err"])
  },
  methods: {
    ...mapMutations(["updataErr"]),
    ...mapActions({ actionUpdataErr: "updataErr" })
  },
  created() {
    this.songListDetail = JSON.parse(
      window.localStorage.getItem("hotSongListDetail")
    ).playlist;
  },
  beforeRouteEnter(to, from, next) {
    // 获取数据
    let cacheSongListDetail = JSON.parse(
      window.localStorage.getItem("hotSongListDetail")
    );
    if (cacheSongListDetail && cacheSongListDetail.expire > Date.now()) {
      next(vm => {
        vm.songListDetail = cacheSongListDetail.playlist;
      });
    } else {
      window.axios
        .get("/top/list?idx=1")
        .then(response => {
          // 获取到的数据放入本地存储
          window.localStorage.setItem(
            "hotSongListDetail",
            JSON.stringify({
              expire: Date.now() + 3 * 60 * 60 * 1000,
              playlist: response.data.playlist
            })
          );
          next(vm => {
            vm.songListDetail = response.data.playlist;
          });
        })
        .catch(function() {});
    }
  }
};
</script>

<style lang="less">
@red: #dd001b;

.playlist {
  .poster {
    height: 122px;
    background: url(../assets/hot_music_bg_2x.jpg);
    background-size: 100% auto;
    position: relative;
    .poster-content {
      min-width: 576px;
      background: url(../assets/index_icon_2x.png) no-repeat #d78862de;
      background-size: contain;
      width: 100%;
      height: 100%;
    }
  }
  .song-item:nth-of-type(-n + 3) {
    .song-number {
      color: @red;
    }
  }
}
</style>