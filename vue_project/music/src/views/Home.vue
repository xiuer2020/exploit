<template>
  <div class="home">
    <div class="loading" v-if="showLoading">
      <img src="../assets/loading.svg" alt />
    </div>
    <HomeLink></HomeLink>

    <div class="personalized">
      <CardTitle>推荐歌单</CardTitle>
      <ul class="songList">
        <SongListCard v-for="(item, index) in slicePersonalizeds" :key="index" :songList="item"></SongListCard>
      </ul>
    </div>

    <div class="newsong">
      <cardTitle>推荐音乐</cardTitle>
      <ul>
        <SongItem
          v-for="(item, index) in newsongs"
          :key="index"
          :songItem="item"
          :showNumber="false"
          :currentSong="currentSong"
          :playing="playing"
          @tanslate-song="$emit('tanslate-song',$event)"
        ></SongItem>
      </ul>
    </div>
  </div>
</template>

<script>
import HomeLink from "../components/HomeLink.vue";
import CardTitle from "../components/CardTitle.vue";
import SongListCard from "../components/SongListCard.vue";
import SongItem from "../components/SongItem.vue";
import { mapState, mapMutations, mapActions } from "vuex";
export default {
  name: "Home",
  props: {
    currentSong: Object,
    playing: Boolean
  },
  components: {
    HomeLink,
    CardTitle,
    SongListCard,
    SongItem
  },
  data: function() {
    return {
      personalizeds: [],
      newsongs: [],
      showLoading: false,
      PlayBarShow: false
    };
  },
  computed: {
    ...mapState(['err']),
    slicePersonalizeds: function() {
      return [...this.personalizeds].slice(0, 6);
    }
  },
  methods: {
    ...mapMutations(['updataErr']),
    ...mapActions({'actionUpdataErr':'updataErr'}),
    // 获取歌单数据
    // 获取数据
    getPersonalized: function() {
      this.axios
        .get("/personalized")
        .then(response => {
          //
          this.showLoading = false;
          // 更新数据
          this.personalizeds = response.data.result;
          // 更新缓存
          window.localStorage.setItem(
            "personalizeds",
            JSON.stringify({
              expire: Date.now() + 1 * 60 * 60 * 1000,
              result: response.data.result
            })
          );
        })
        .catch(function(err) {
          this.actionUpdataErr(err)
        });
    },

    // 获取最新音乐数据
    // 获取数据
    getNewSong: function() {
      this.axios
        .get("/personalized/newsong")
        .then(response => {
          // 更新数据
          this.showLoading = false;
          this.newsongs = response.data.result;
          // 更新缓存
          window.localStorage.setItem(
            "newsongs",
            JSON.stringify({
              expire: Date.now() + 1 * 60 * 60 * 1000,
              result: response.data.result
            })
          );
        })
        .catch(function(err) {
          this.actionUpdataErr(err)
        });
    }
  },
  created() {
    // 
    

    // 

    // 根据缓存做出获取推荐歌单数据操作
    // 根据缓存做出数据操作
    let personalizedCache = window.localStorage.getItem("personalizeds");
    if (personalizedCache) {
      personalizedCache = JSON.parse(personalizedCache);
      if (personalizedCache && personalizedCache.expire > Date.now()) {
        this.personalizeds = personalizedCache.result;
      } else {
        this.showLoading = true;
        this.getPersonalized();
      }
    } else {
      this.showLoading = true;
      this.getPersonalized();
    }

    // 根据缓存做出获取推荐音乐数据操作
    // 根据缓存做出数据操作
    let cacheNewsongs = window.localStorage.getItem("newsongs");
    if (cacheNewsongs) {
      cacheNewsongs = JSON.parse(cacheNewsongs);
      if (cacheNewsongs && cacheNewsongs.expire > Date.now()) {
        this.newsongs = cacheNewsongs.result;
      } else {
        this.showLoading = true;
        this.getNewSong();
      }
    } else {
      this.showLoading = true;
      this.getNewSong();
    }
  }
};
</script>

<style lang="less" scoped>
@red: #dd001b;
@margin-top: 20px;
@margin-bottom: 14px;
@black: #333;
@gray: #888;
.loading {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100vh;
  background: #00000094;
  z-index: 999;
}
.personalized {
  padding: 0 16px;
  ul.songList {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    li {
      width: 30%;
    }
  }
}
.newsong {
  padding: 16px;
}
</style>