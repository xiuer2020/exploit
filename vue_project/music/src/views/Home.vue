<template>
  <div class="home">
    <!-- 播放器 边栏 -->
    <PlayBar></PlayBar>
    <LoadingComp></LoadingComp>
    <HomeLink></HomeLink>

    <div class="personalized">
      <CardTitle>推荐歌单</CardTitle>
      <ul class="songList">
        <SongListCard v-for="(item, index) in slicePersonalizeds" :key="index" :songList="item"></SongListCard>
      </ul>
    </div>

    <div class="newsong">
      <cardTitle>推荐音乐</cardTitle>
      <ul>
        <SongItem
          v-for="(item, index) in newsongs"
          :key="index"
          :songItem="item"
          :showNumber="false"
        ></SongItem>
      </ul>
    </div>
    <PageBase></PageBase>
  </div>
</template>

<script>
import cache from "../assets/js/cache";
import api from "../api/api";
import { mapState, mapMutations, mapActions, mapGetters } from "vuex";
import types from "../store/modules/types";

import PlayBar from "../components/PlayBar.vue";
import HomeLink from "../components/HomeLink.vue";
import CardTitle from "../components/CardTitle.vue";
import SongListCard from "../components/SongListCard.vue";
import SongItem from "../components/SongItem.vue";
import LoadingComp from "../components/LoadingComp.vue";
import PageBase from "../components/PageBase.vue";

export default {
  name: "home",
  components: {
    PlayBar,
    HomeLink,
    CardTitle,
    SongListCard,
    SongItem,
    LoadingComp,
    PageBase
  },
  computed: {
    ...mapState(["currentSong"]),
    ...mapState("home", ["personalizeds", "newsongs"]),
    ...mapGetters("home", ["slicePersonalizeds"]),
    ...mapState(["err", "PlayBarShow", "showLoading"])
  },
  methods: {
    ...mapMutations([`${types.UPDATE}`]),
    ...mapActions({
      [`action${types.UPDATE}`]: `${types.UPDATE}`
    })
  },
  created() {
    cache.init(
      "personalizeds",
      () => {
        this.UPDATE({
          key: "personalizeds",
          value: cache.parse("personalizeds"),
          name: "home"
        });
        // 更新歌单数据
      },
      () => {
        this.UPDATE({ key: "showLoading", value: true });
        // loading交互
        this.axios
          .get(api.home.newSongList)
          .then(res => {
            // console.log(res);
            this.UPDATE({
              key: "personalizeds",
              value: res.data.result,
              name: "home"
            });
            // 网络请求歌单数据
            localStorage.setItem(
              "personalizeds",
              JSON.stringify({
                expires: Date.now() + 60 * 10000,
                data: res.data.result
              })
            );
            // 更新缓存
            this.UPDATE({ key: "showLoading", value: false });
          })
          .catch(err => {
            this.UPDATE({ key: "err", value: err });
            // 报错提示
          });
        // loading交互
      }
    );
    // 获取歌单数据

    cache.init(
      "newsongs",
      () => {
        this.UPDATE({
          key: "newsongs",
          value: cache.parse("newsongs"),
          name: "home"
        });
        // 更新新音乐数据
      },
      () => {
        this.UPDATE({ key: "showLoading", value: true });
        // loading交互

        this.axios
          .get(api.home.newSongs)
          .then(res => {
            // 网络请求新音乐数据
            //
            this.UPDATE({
              key: "newsongs",
              value: res.data.result,
              name: "home"
            });
            // 更新新音乐数据
            localStorage.setItem(
              "newsongs",
              JSON.stringify({
                expires: Date.now() + 60 * 10000,
                data: res.data.result
              })
            );

            this.UPDATE({ key: "showLoading", value: false });
          })
          .catch(err => {
            this.UPDATE({ key: "err", value: err });
            // 报错提示
          });
        // loading交互
      }
    );
    // 获取新音乐数据
    // 初始化数据
  }
};
</script>

<style lang="less" scoped>
.home {
  padding-top: 38px;
  .personalized {
    padding: 0 16px;
    ul.songList {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      li {
        width: 30%;
      }
    }
  }
  .newsong {
    padding: 16px;
  }
}
</style>
