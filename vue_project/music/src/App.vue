<template>
  <div id="app" @touchstart="touchstart" @touchend="touchend">
    <!-- 一级路由出口 -->
    <keep-alive>
      <!-- 嵌套路由 -->
      <router-view @tanslate-song="switchCurrentSong" :playing="playing" :currentSong="currentSong"></router-view>
    </keep-alive>

    <!-- 播放器 边栏 -->
    <PlayBar
      :currentSong="currentSong"
      :currentSongList="currentSongList"
      v-if="PlayBarShow"
      :playing="playing"
      @togglePlay="togglePlay"
      @tanslate-song="switchCurrentSong"
    ></PlayBar>
    <audio :src="currentSongUrl" autoplay controls height="30"></audio>
  </div>
</template>
<script>
import PlayBar from "@/components/PlayBar";

export default {
  components: {
    PlayBar
  },
  data: function() {
    return {
      currentSong: { id: "" },
      currentSongList: [],
      touchstartX: 0,
      PlayBarShow: false,
      playing: false
    };
  },
  computed: {
    currentSongUrl: function() {
      return `https://music.163.com/song/media/outer/url?id=${this.currentSong.id}.mp3`;
    }
  },
  watch: {
    // 当前播放id变化
    playing: function(playing) {
      // 

      var audio = this.$el.querySelector("audio");

      if (playing) {
        audio.play();
      } else {
        audio.pause();
      }
    }
  },
  methods: {
    togglePlay: function(playing) {
      // 
      this.playing = playing;
    },
    // 切换歌曲
    switchCurrentSong: function(currentSong) {
      // 

      this.currentSong = currentSong;
      if (this.currentSongList) {
        for (var i = 0; i < this.currentSongList.length; i++) {
          if (this.currentSongList[i].id === this.currentSong.id) {
            break;
          }
        }
      }
      if (i === this.currentSongList.length) {
        this.currentSongList.push(currentSong);
      }
      this.PlayBarShow = true;
    },

    touchstart: function(event) {
      // 
      this.touchstartX = event.changedTouches[0].clientX;
      this.touchstartY = event.changedTouches[0].clientY;
    },
    touchend: function(event) {
      // 

      // 判断左滑动 返回上一页
      if (event.changedTouches[0].clientX - this.touchstartX > 50) {
        
        this.touchstartX = 0;
        this.touchstartY = 0;
        this.routerBack();
      }

      if (event.changedTouches[0].clientX - this.touchstartX < -50) {
        
        this.routerForward();
      }
    },
    routerBack: function() {
      this.$router.back();
    },
    routerForward: function() {
      this.$router.forward();
    }
  },
  mounted() {
    var audio = this.$el.querySelector("audio");
    

    // 更新播放状态
    audio.onplay = () => {
      this.playing = true;
    };
    audio.onpause = () => {
      this.playing = false;
    };
  }
};
</script>
<style lang="less">
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  color: #2c3e50;
  padding-bottom: 50px;
}
</style>
