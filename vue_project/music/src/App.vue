<template>
  <div id="app" @touchstart.stop="touchstart" @touchend.stop="touchend">
    <router-view></router-view>
    <!-- 一级路由出口 -->

    <audio :src="currentSongUrl" controls height="30" width="100"></audio>
  </div>
</template>
<script>
import { mapState, mapMutations, mapGetters } from "vuex";
import types from "@/store/modules/types.js";

export default {
  computed: {
    ...mapState(["playing", "currentSong", "audio"]),
    ...mapState("app", ["touchstartX", "differX"]),
    ...mapGetters(["currentSongUrl", "currentSongDuration"])
  },
  watch: {
    playing: function(v) {
      var audio = this.$el.querySelector("audio");
      if (v) {
        let timer = setInterval(() => {
          if (audio.readyState) {
            audio.play();
            clearInterval(timer);
          }
        }, 1000);
      } else {
        audio.pause();
      }
      // playing 映射播放器播放状态
    },

    currentSong: function() {
      this.UPDATE({ key: "playing", value: true });
      // 更新 playing 配合playing映射

      var audio = this.$el.querySelector("audio");
      if (this.playing) {
        let timer = setInterval(() => {
          if (audio.readyState) {
            audio.play();
            clearInterval(timer);
          }
        }, 1000);
      } else {
        audio.pause();
      }
      // playing 映射播放器播放状态
    }
  },
  methods: {
    ...mapMutations([types.UPDATE]),

    touchstart: function(event) {
      this.UPDATE({
        key: "touchstartX",
        value: event.changedTouches[0].clientX,
        name: "app"
      });
      // 更新开始触摸水平值
    },

    touchend: function(event) {
      if (event.changedTouches[0].clientX - this.touchstartX > this.differX) {
        // 判断左滑动

        this.$router.back();
        // 返回上一页
      } else if (
        event.changedTouches[0].clientX - this.touchstartX <
        -this.differX
      ) {
        // 判断右滑动

        this.$router.forward();
        // 前进一页
      }
    }
  }
};
</script>
<style lang="less">
audio {
  display: none;
}
</style>
