<template>
  <!-- 全屏页脱标,可用stop修饰符简单实现点击交互 -->
  <div class="play-bar">
    <div class="play-bar-bottom">
      <div class="left" @click.stop="showsFullSreen = true">
        <div class="play-bar-img">
          <img :src="currentSongPicUrl" alt v-if="currentSongPicUrl" />
        </div>
        <div class="song-introduce-box">
          <!-- 特例接口 -->
          <div class="song-name">{{currentSong.name}}</div>
          <div class="song-artist">{{joinArtists(currentSongArtists)}}</div>
        </div>
      </div>
      <div class="right" @click.stop="showsFullSreen = true">
        <div class="control" @click.stop="$emit('togglePlay',!playing)">
          <canvas width="36" heightf="36" id="canvas"></canvas>
          <i v-if="playing" class="fa fa-pause"></i>
          <i v-else class="fa fa-play"></i>
        </div>
        <i
          class="fa fa-list-alt list"
          aria-hidden="true"
          @click.stop="showCurrentSongList = !showCurrentSongList"
        ></i>
      </div>
      <template v-if="showCurrentSongList">
        <div class="mask"></div>
        <div class="current-song-list-box">
          <ul class="current-song-list">
            <SongItem
              v-for="(item,index) in currentSongList"
              :key="index"
              @tanslate-song="$emit('tanslate-song',$event)"
              :songItem="item"
              :currentSong="currentSong"
              :playing="playing"
              :number="index"
              :showNumber="true"
            ></SongItem>
          </ul>
        </div>
      </template>
    </div>

    <div class="full-creen-details" @click.stop="lyricPage = !lyricPage" v-if="showsFullSreen">
      <img :src="currentSongPicUrl" alt class="bg-img-filter" />
      <div class="page-guide" @click.stop="showsFullSreen = false">
        <i class="fa fa-reply" aria-hidden="true"></i>
      </div>
      <div class="lyric-box" v-if="lyricPage">
        <ul class="lyric" :style="{transform: `translateY(${-currentLyricIndex * 28}px)`}">
          <li
            v-for="(item, index) in compileLlyrics"
            :key="index"
            :class="{active: index===currentLyricIndex}"
          >{{item.text}}</li>
        </ul>
      </div>
      <div class="playing-page" v-else :style="`backgrou-image:url(${currentSongPicUrl})`">
        <div class="black-adhesive">
          <img :src="currentSongPicUrl" alt />
        </div>
        <div class="controls">
          <i class="fa fa-fast-backward" aria-hidden="true" @click.stop="switchPrevSong"></i>
          <i
            class="fa fa-pause"
            aria-hidden="true"
            @click.stop="$emit('togglePlay',!playing)"
            v-if="playing"
          ></i>
          <i
            class="fa fa-play"
            aria-hidden="true"
            @click.stop="$emit('togglePlay',!playing)"
            v-else
          ></i>
          <i class="fa fa-fast-forward" aria-hidden="true" @click.stop="switchNextSong"></i>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import SongItem from "../components/SongItem";
export default {
  name: "PlayBar",
  props: {
    currentSong: Object,
    currentSongList: Array,
    playing: Boolean
  },
  components: {
    SongItem
  },
  data: function() {
    return {
      currentSongListIndex: 0,
      currentLyric: {},
      currentLyricIndex: null,
      showsFullSreen: false,
      lyricPage: true,
      showCurrentSongList: false
    };
  },
  computed: {
    // 数据判断
    currentSongPicUrl: function() {
      if (this.currentSong.picUrl) {
        return this.currentSong.picUrl;
      } else if (this.currentSong.al) {
        return this.currentSong.al.picUrl;
      } else if (this.currentSong.artists) {
        return this.currentSong.artists.img1v1Url;
      } else {
        return null;
      }
    },
    currentSongArtists: function() {
      if (this.currentSong.song) {
        return this.currentSong.song.artists;
      } else if (this.currentSong.ar) {
        return this.currentSong.ar;
      } else if (this.currentSong.artists) {
        return this.currentSong.artists;
      } else {
        return null;
      }
    },
    currentSongDuration: function() {
      if (this.currentSong.song) {
        return this.currentSong.song.duration;
      } else if (this.currentSong.dt) {
        return this.currentSong.dt;
      } else if (this.currentSong.duration) {
        return this.currentSong.duration;
      } else {
        return null;
      }
    },

    // 编译歌词
    compileLlyrics: function() {
      if (this.currentLyric) {
        return this.currentLyric.split("\n").map(item => {
          //
          var regex = /\d{2}:\d{2}\.\d+/i;
          if (item.search(regex) !== -1) {
            var time = item.match(regex)[0];
            var m = time.substr(0, 2);
            var s = time.substr(3, 2);
            var n = time.substr(5);
            return {
              time: Number(m) * 60 + Number(s) + Number(n),
              text: item.substr(11) || "---------"
            };
          } else {
            return {};
          }
        });
      } else {
        return null;
      }
    }
  },
  watch: {
    // 监听歌曲切换
    currentSong: function() {
      // 更新歌词数据
      this.getLyric();
    }
  },
  methods: {
    // 根据缓存更新数据
    // 根据缓存更新歌词数据
    getLyric: function() {
      var cachedLyric = window.localStorage.getItem(
        "lyric" + this.currentSong.id
      );

      if (cachedLyric) {
        //

        this.currentLyric = cachedLyric;
      } else {
        //
        window.axios
          .get("lyric", {
            params: {
              id: this.currentSong.id
            }
          })
          .then(response => {
            

            this.currentLyric = response.data.lrc.lyric;
            window.localStorage.setItem(
              "lyric" + this.currentSong.id,
              response.data.lrc.lyric
            );
          });
      }
    },

    // 拼接歌手名
    joinArtists: function(artists) {
      return artists.map(artist => artist.name).join("/");
    },

    // 播放进度条动画
    drawProgress: function() {
      //

      var canvas = this.$el.querySelector("#canvas");
      // 获取父级audio

      var audio = this.$parent.$el.querySelector("audio");

      var duration = this.currentSongDuration;

      audio.ontimeupdate = () => {
        //
        if (audio.currentTime >= audio.duration) {
          this.currentSongIndex = this.currentSongIndex + 1;
          this.currentSong = this.currentSongList[this.currentSongIndex];
        }

        /** @type {HTMLCanvasElement} */
        //
        // 获取canvas元素
        var context = canvas.getContext("2d");
        //
        //
        context.clearRect(0, 0, 36, 36);

        context.beginPath();
        context.arc(18, 18, 17, 0, 2 * Math.PI);
        context.closePath();
        context.strokeStyle = "gray";
        // 描边样式
        context.lineWidth = "1";
        // 描边宽度
        context.stroke(); // 路径描边

        context.closePath();
        context.beginPath();
        context.arc(
          18,
          18,
          17,
          -0.5 * Math.PI,
          -0.5 * Math.PI + 2 * Math.PI * ((audio.currentTime * 1000) / duration)
        );
        // context.closePath();
        context.strokeStyle = "rgba(255,0,0,0.7)";
        // 描边样式
        context.lineWidth = "1";
        // 描边宽度
        context.stroke(); // 路径描边

        // 滚动歌词动画
        if (this.currentLyric) {
          let index;

          for (let i = 0; i < this.compileLlyrics.length; i++) {
            if (audio.currentTime + 0.15 < this.compileLlyrics[i].time) {
              index = i - 1;
              break;
            }
          }
          if (index === undefined) {
            index = this.compileLlyrics.length - 1;
          }
          this.currentLyricIndex = index;
        }
        //
      };
    },
    switchPrevSong: function() {
      //

      //   "上一首,this.currentSongListIndex",
      //   this.currentSongListIndex
      // );

      if (this.currentSongListIndex > 0) {
        // this.currentSongListIndex = this.currentSongListIndex + 1;
        this.currentSongListIndex -= 1;

        this.$emit(
          "tanslate-song",
          this.currentSongList[this.currentSongListIndex]
        );
      } else {
        this.currentSongListIndex = this.currentSongList.length - 1;
        this.$emit(
          "tanslate-song",
          this.currentSongList[this.currentSongList.length - 1]
        );
      }
    },
    switchNextSong: function() {
      if (this.currentSongListIndex < this.currentSongList.length - 1) {
        this.currentSongListIndex += 1;
        this.$emit(
          "tanslate-song",
          this.currentSongList[this.currentSongListIndex]
        );
      } else {
        this.currentSongListIndex = 0;
        this.$emit("tanslate-song", this.currentSongList[0]);
      }
    },
    removeDuplication: function(array) {
      var arr = [];
      for (var i = 0; i < array.length; i++) {
        if (arr.indexOf(array[i]) === -1) {
          arr.push(array[i]);
        }
      }
      return arr;
    }
  },
  created() {
    this.getLyric();
  },
  mounted() {
    // 进度条动画
    this.drawProgress();
  }
};
</script>

<style lang="less" scoped>
.play-bar {
  width: 100%;
  background: #ffffff;
  border-top: 1px solid #c3c3c3;
  position: fixed;
  left: 0;
  bottom: 0;
  audio {
    display: none;
  }

  .play-bar-bottom {
    display: flex;
    justify-content: space-between;
    padding: 16px;
    height: 70px;
    background: #fff;
    position: relative;
    .mask {
      position: fixed;
      left: 0;
      top: 0;
      background: #00000054;
      width: 100vw;
      height: 100vh;
      z-index: -2;
    }
    .current-song-list-box {
      overflow: hidden;
      position: absolute;
      bottom: 70px;
      padding: 14px;
      left: 0%;
      width: 100%;
      // height: 40vh;
      background: #ffffff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      z-index: 2;
      backface-visibility: #ffffff;
      .current-song-list > li {
        background: #ffffff;
        cursor: pointer;
        border-top-left-radius: 15px;
        border-top-right-radius: 15px;
      }
    }
    .left {
      font-size: 12px;
      color: #888888;
      display: flex;
      width: calc(100% - 80px);
      .song-introduce-box {
        margin-left: 14px;
      }
      .song-name {
        color: #333333;
      }
      .play-bar-img {
        width: 40px;
        img {
          width: 100%;
          border-radius: 50%;
        }
      }
    }
    .right {
      display: flex;
      width: 80px;
      .control {
        position: relative;
        i {
          position: absolute;
          left: 12px;
          top: 21%;
        }
      }
      i.list {
        border: 1px solid #000;
        width: 34px;
        height: 34px;
        text-align: center;
        line-height: 34px;
        border-radius: 50%;
        margin-left: 5px;
      }
    }
  }

  .full-creen-details {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100vh;
    padding: 5px;
    background: #b7b7b7;
    z-index: 999;
    &::before {
      position: fixed;
      left: 0;
      top: 0;
      background: #00000054;
      width: 100vw;
      height: 100vh;
      z-index: -2;
      content: '';
    }
    img.bg-img-filter {
      width: 100vw;
      height: 100vh;
      filter: blur(24px);
      transform: scale(2.5);
      position: absolute;
      left: 0;
      top: 0;
      z-index: -999;
    }
    .lyric-box {
      height: 290px;
      overflow: hidden;
      position: relative;
      margin-top: 72px;
      img.bg-img-filter {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0;
        top: 0;
      }
      ul.lyric {
        position: absolute;
        left: 0;
        top: 50%;
        transition: transform 0.4s;
        li {
          width: 100vw;
          color: #e6e6e6;
          text-align: center;
          line-height: 28px;
          font-size: 14px;
          &.active {
            color: #ff0000;
          }
        }
      }
    }
    .playing-page {
      .black-adhesive {
        margin: auto auto;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 287px;
        height: 287px;
        background: url("../assets/disc_light-ip6.png"),
          url("../assets/disc-ip6.png");
        background-size: 100% auto;
        img {
          width: 185px;
          border-radius: 50%;
        }
      }
      .controls {
        display: flex;
        margin-top: 30px;
        margin-bottom: 14px;
        justify-content: space-around;
        i {
          color: #f7dbdb;
          display: block;
          text-align: center;
          border-radius: 50%;
          &::before {
            font-size: 76px;
          }
        }
      }
    }
  }
}
</style>