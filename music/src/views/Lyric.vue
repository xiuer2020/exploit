<template>
  <div class="lyric" v-if="currentLyric" @click="$router.push('control')">
    <LoadingComp></LoadingComp>
    <BgFilter></BgFilter>
    <Guide></Guide>
    <div class="current-lyric-outer-layout">
      <ul
        class="current-lyric-inner-layout"
        :style="{ transform: `translateY(${-currentLyricIndex * 28}px)` }"
      >
        <li
          v-for="(item, index) in compileLlyrics"
          :key="index"
          :class="{ active: index === currentLyricIndex }"
        >
          {{ item.text }}
        </li>
      </ul>
    </div>
  </div>
</template>

<script>
import BgFilter from "../components/BgFilter";
import cache from "../assets/js/cache";
import api from "../api/api";
import types from "../store/modules/types";
import LoadingComp from "../components/LoadingComp.vue";
import { mapState, mapGetters, mapMutations } from "vuex";
import Guide from "../components/Guide";
export default {
  components: { Guide, BgFilter, LoadingComp },
  computed: {
    ...mapState([
      "currentSong",
      "showLoading",
      "currentSongList",
      "currentSongListIndex",
      "lyricPage",
    ]),
    ...mapState("lyric", [
      "currentLyricIndex",
      "currentLyric",
      "lyricShowTimeDiffer",
    ]),
    ...mapGetters(["currentSongDuration"]),
    ...mapGetters("lyric", ["compileLlyrics"]),
  },
  methods: {
    ...mapMutations([types.UPDATE]),
  },
  created() {
    cache.init(
      "currentLyric",
      () => {
        this.UPDATE({
          key: "currentLyric",
          value: cache.parse("currentLyric", `${this.currentSong.id}`),
          name: "lyric",
        });
        // 更新新音乐数据
      },
      () => {
        this.UPDATE({ key: "showLoading", value: "true" });
        // loading交互

        this.axios
          .get(`${api.lyric.lyric}?id=${this.currentSong.id}`)
          .then((res) => {
            // 网络请求新音乐数据

            this.UPDATE({ key: "showLoading", value: false });
            // loading交互

            console.log(res);
            this.UPDATE({
              key: "currentLyric",
              value: res.data.lrc.lyric,
              name: "lyric",
            });
            // 更新新音乐数据

            localStorage.setItem(
              `currentLyric${this.currentSong.id}`,
              JSON.stringify({
                expires: Date.now() + 60 * 10000,
                data: res.data.lrc.lyric,
              })
            );
            // 更新缓存
          })
          .catch((err) => {
            this.UPDATE({ key: "err", value: err });
            // 报错提示
          });
        // loading交互
      },
      `${this.currentSong.id}`
    );
    // 更新歌词数据
  },
  watch: {
    currentSong: function () {
      this.UPDATE({ key: "currentLyricIndex", value: 0, name: "lyric" });
      // 更新currentLyricIndex

      cache.init(
        "currentLyric",
        () => {
          this.UPDATE({
            key: "currentLyric",
            value: cache.parse("currentLyric", `${this.currentSong.id}`),
            name: "lyric",
          });
          // 更新新音乐数据
        },
        () => {
          this.UPDATE({ key: "showLoading", value: "true" });
          // loading交互

          this.axios
            .get(`${api.lyric.lyric}?id=${this.currentSong.id}`)
            .then((res) => {
              // 网络请求新音乐数据

              this.UPDATE({ key: "showLoading", value: false });
              // loading交互

              console.log(res);
              this.UPDATE({
                key: "currentLyric",
                value: res.data.lrc.lyric,
                name: "lyric",
              });
              // 更新新音乐数据

              localStorage.setItem(
                `currentLyric${this.currentSong.id}`,
                JSON.stringify({
                  expires: Date.now() + 60 * 10000,
                  data: res.data.lrc.lyric,
                })
              );
              // 更新缓存
            })
            .catch((err) => {
              this.UPDATE({ key: "err", value: err });
              // 报错提示
            });
          // loading交互
        },
        `${this.currentSong.id}`
      );
      // 更新歌词数据
    },
  },
  beforeRouteEnter(to, from, next) {
    next((vm) => {
      if (from.name !== "control") {
        vm.UPDATE({ key: "prevPath", value: from.fullPath });
        vm.UPDATE({ key: "lyricPage", value: true });
      } else {
        vm.UPDATE({ key: "lyricPage", value: true });
      }
      // 更新点击播放栏是否显示歌词页 和 点击播放栏的路径

      var audio = vm.$root.$el.querySelector("audio");
      // 获取audio节点
      var duration = vm.currentSongDuration;
      // 获取歌曲时长 单位 s
      audio.ontimeupdate = () => {
        if ((audio.currentTime + 2) * 1000 >= duration) {
          if (vm.currentSongListIndex !== vm.currentSongList.length - 1) {
            vm.UPDATE({
              key: "currentSongListIndex",
              value: vm.currentSongListIndex + 1,
            });
            // 更新currentSongListIndex
          } else {
            vm.UPDATE({
              key: "currentSongListIndex",
              value: 0,
            });
            // 更新currentSongListIndex
          }

          vm.UPDATE({
            key: "currentSong",
            value: vm.currentSongList[vm.currentSongListIndex],
          });
          // 更新currentSong

          if (vm.currentSongList.length === 1) {
            vm.UPDATE({ key: "playing", value: false });
          }
        }
        // 当歌曲播放完毕

        if (vm.compileLlyrics.length !== 0) {
          for (let i = 0; i < vm.compileLlyrics.length; i++) {
            if (
              audio.currentTime + vm.lyricShowTimeDiffer <
              vm.compileLlyrics[i].time
            ) {
              vm.UPDATE({
                key: "currentLyricIndex",
                value: i - 1,
                name: "lyric",
              });
              // 更新currentLyricIndex

              break;
            }
          }
        }

        // 滚动歌词动画
      };
    });
  },
  beforeRouteLeave(to, from, next) {
    var audio = this.$root.$el.querySelector("audio");
    audio.ontimeupdate = null;
    next();
  },
};
</script>
<style lang="less" scoped>
.lyric {
  position: relative;

  height: 100vh;
  padding-top: 72px;

  font-size: 14px;
        color: #e6e6e6;

  box-sizing: border-box;
  overflow: hidden;
  background: #0005;
  .current-lyric-outer-layout {
    position: fixed;
    left: 0;
    top: 20vh;
    bottom: 20vh;
    right: 0;

    overflow: hidden;
    ul.current-lyric-inner-layout {
      position: absolute;
      left: 0;
      top: 50%;
      transition: transform 0.4s;

      li {
        width: 100vw;

        text-align: center;
        line-height: 28px;

        &.active {
          color: @c-r;
        }
      }
    }
  }
}
</style>